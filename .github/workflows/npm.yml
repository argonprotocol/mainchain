name: Publish NPM

on:
  repository_dispatch:
    types:
      - npm-dev-publish
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag:
        description: 'The release tag to publish (for example: v1.4.0)'
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:
  publish:
    name: Publish packages
    if: github.event_name != 'repository_dispatch' || github.actor == 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      id-token: write
    steps:
      - name: Validate dispatch source run
        if: github.event_name == 'repository_dispatch'
        id: validate_dispatch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_RUN_ID: ${{ github.event.client_payload.source_run_id }}
          PAYLOAD_SHA: ${{ github.event.client_payload.head_sha }}
        run: |
          set -euo pipefail

          if [[ ! "$SOURCE_RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "Invalid source_run_id payload" >&2
            exit 1
          fi
          if [[ ! "$PAYLOAD_SHA" =~ ^[0-9a-f]{40}$ ]]; then
            echo "Invalid head_sha payload" >&2
            exit 1
          fi

          if ! RUN_JSON="$(gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${SOURCE_RUN_ID}")"; then
            echo "Unable to fetch source run metadata for run id ${SOURCE_RUN_ID}" >&2
            exit 1
          fi
          if ! jq -e --arg sha "$PAYLOAD_SHA" '
            .name == "Build + Test Node.js Apis" and
            .event == "push" and
            .head_branch == "main" and
            .head_sha == $sha
          ' <<<"$RUN_JSON" >/dev/null; then
            echo "Dispatch payload did not match expected source run metadata" >&2
            jq -c '{name, event, head_branch, head_sha}' <<<"$RUN_JSON" >&2
            exit 1
          fi
          RUN_SHA="$(jq -r '.head_sha' <<<"$RUN_JSON")"

          echo "source_run_id=$SOURCE_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "head_sha=$RUN_SHA" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && steps.validate_dispatch.outputs.head_sha || github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.event_name == 'release' && github.event.release.tag_name || github.ref_name }}
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: yarn
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: yarn install

      - name: Download localchain bindings
        if: github.event_name == 'repository_dispatch'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.validate_dispatch.outputs.source_run_id }}
          pattern: bindings-*
          path: localchain/artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bitcoin artifacts
        if: github.event_name == 'repository_dispatch'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.validate_dispatch.outputs.source_run_id }}
          name: bitcoin-wasm
          path: bitcoin/nodejs/ts/wasm
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve release tag
        if: github.event_name != 'repository_dispatch'
        id: release_tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          fi
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            TAG="${{ github.ref_name }}"
          fi
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            echo "Unable to resolve release tag" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate workflow dispatch release is published
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ steps.release_tag.outputs.tag }}"
          if ! RELEASE_JSON="$(gh api "repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}")"; then
            echo "No release found for tag $TAG. Ensure the release exists and is published before running this workflow." >&2
            exit 1
          fi

          if ! jq -e '.draft == false and (.published_at != null)' <<<"$RELEASE_JSON" >/dev/null; then
            echo "workflow_dispatch requires an already published release for tag $TAG" >&2
            exit 1
          fi

      - name: Download localchain artifacts
        if: github.event_name != 'repository_dispatch'
        run: gh release download ${{ steps.release_tag.outputs.tag }} --dir ./localchain/artifacts --pattern '*.node'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bitcoin artifacts from release
        if: github.event_name != 'repository_dispatch'
        run: |
          gh release download ${{ steps.release_tag.outputs.tag }} --dir ./bitcoin/nodejs/ts/wasm --pattern 'bitcoin-wasm.tar.gz'
          tar -xzf ./bitcoin/nodejs/ts/wasm/bitcoin-wasm.tar.gz -C ./bitcoin/nodejs/ts/wasm
          ls -R ./bitcoin/nodejs/ts/wasm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build typescript
        run: yarn tsc

      - name: Move artifacts
        run: yarn artifacts
        working-directory: ./localchain

      - name: Compute npm dev version
        if: github.event_name == 'repository_dispatch'
        id: npm_dev_version
        run: |
          BASE_VERSION=$(node -e "const version = require('./client/nodejs/package.json').version.replace(/-.*/, ''); if (!/^\\d+\\.\\d+\\.\\d+$/.test(version)) { throw new Error('Invalid semver: ' + version); } console.log(version);")
          HEAD_SHA="${{ steps.validate_dispatch.outputs.head_sha }}"
          SHORT_SHA="${HEAD_SHA:0:8}"
          VERSION="${BASE_VERSION}-dev.${SHORT_SHA}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Publishing npm dev version: $VERSION"

      - name: Bump workspace versions for dev publish
        if: github.event_name == 'repository_dispatch'
        run: VERSION=${{ steps.npm_dev_version.outputs.version }} yarn version:bump

      - name: Verify artifacts
        run: ls -R ./npm
        working-directory: ./localchain

      - name: Publish mainchain
        if: ${{ vars.NPM_ENABLED == 'true' }}
        run: |
          PUBLISH_ARGS=(--access public)
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            PUBLISH_ARGS+=(--tag dev)
          fi
          npm publish "${PUBLISH_ARGS[@]}" --workspace=client/nodejs
          npm publish "${PUBLISH_ARGS[@]}" --workspace=localchain
          npm publish "${PUBLISH_ARGS[@]}" --workspace=bitcoin/nodejs
          npm publish "${PUBLISH_ARGS[@]}" --workspace=testing/nodejs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
