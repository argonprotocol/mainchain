name: Publish NPM

on:
  workflow_run:
    workflows:
      - Build + Test Node.js Apis
    branches:
      - main
    types:
      - completed
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Defaults to current ref.'
        required: false
      tag:
        description: 'Release tag to fetch artifacts from. Defaults to latest non-prerelease.'
        required: false
      dry_run:
        description: 'Use npm publish --dry-run'
        required: true
        type: boolean
        default: true
  push:
    tags:
      - v[0-9]+.*
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

defaults:
  run:
    shell: bash

jobs:
  publish:
    name: Publish packages
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || github.event_name == 'push' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.event_name == 'workflow_dispatch' && inputs.ref || github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref_name }}
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: yarn
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: yarn install

      - name: Download localchain bindings
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          pattern: bindings-*
          path: localchain/artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bitcoin artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: bitcoin-wasm
          path: bitcoin/nodejs/ts/wasm
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve release tag
        if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        id: release_tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.tag }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="$(gh release list --exclude-pre-releases --json tagName --jq '.[0].tagName')"
          fi
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            echo "Unable to resolve release tag" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download localchain artifacts
        if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: gh release download ${{ steps.release_tag.outputs.tag }} --dir ./localchain/artifacts --pattern *.node
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bitcoin artifacts from release
        if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: |
          gh release download ${{ steps.release_tag.outputs.tag }} --dir ./bitcoin/nodejs/ts/wasm --pattern bitcoin-wasm.tar.gz
          tar -xzf ./bitcoin/nodejs/ts/wasm/bitcoin-wasm.tar.gz -C ./bitcoin/nodejs/ts/wasm
          ls -R ./bitcoin/nodejs/ts/wasm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build typescript
        run: yarn tsc

      - name: Move artifacts
        run: yarn artifacts
        working-directory: ./localchain

      - name: Compute npm dev version
        if: github.event_name != 'push'
        id: npm_dev_version
        run: |
          BASE_VERSION=$(node -e "const version = require('./client/nodejs/package.json').version.replace(/-.*/, ''); if (!/^\\d+\\.\\d+\\.\\d+$/.test(version)) { throw new Error('Invalid semver: ' + version); } console.log(version);")
          HEAD_SHA="$(git rev-parse HEAD)"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          fi
          SHORT_SHA="${HEAD_SHA:0:8}"
          VERSION="${BASE_VERSION}-dev.${SHORT_SHA}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Publishing npm dev version: $VERSION"

      - name: Bump workspace versions for dev publish
        if: github.event_name != 'push'
        run: VERSION=${{ steps.npm_dev_version.outputs.version }} yarn version:bump

      - name: Verify artifacts
        run: ls -R ./npm
        working-directory: ./localchain

      - name: Publish mainchain
        if: ${{ vars.NPM_ENABLED == 'true' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
        run: |
          PUBLISH_ARGS=(--access public)
          if [[ "${{ github.event_name }}" != "push" ]]; then
            PUBLISH_ARGS+=(--tag dev)
          fi
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PUBLISH_ARGS+=(--dry-run)
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            PUBLISH_ARGS+=(--dry-run)
          fi
          npm publish "${PUBLISH_ARGS[@]}" --workspace=client/nodejs
          npm publish "${PUBLISH_ARGS[@]}" --workspace=localchain
          npm publish "${PUBLISH_ARGS[@]}" --workspace=bitcoin/nodejs
          npm publish "${PUBLISH_ARGS[@]}" --workspace=testing/nodejs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
